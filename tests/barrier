# tccext handles barrier correctly --------------------------------------------
tcc/ext/tcc-ext-echo build 1234 2>&1
block eth0 egress
action 0 = unspec
match 0:0:8=0x02 action 0
barrier
match 0:0:8=0x01 action 0
barrier
match action 0
EOF
block eth0 egress
action 0 = unspec
match 0:0:8=0x2 action 0
barrier
match 0:0:8=0x1 action 0
barrier
match action 0
# barrier is generated by tcc -------------------------------------------------
tcc -xif:err -Xx,nocombine 2>&1 >/dev/null | grep -v '^#'
prio {
   class if raw[0];
   drop if 1;
}
EOF
block eth0 egress
action 0 = drop
action 1 = class 1:1
action 2 = unspec
match 0:0:8=0x00 action 2
match action 1
barrier
match action 0
# tcc-ext-test accepts "nounspec" ---------------------------------------------
tcc/ext/tcc-ext-test config nounspec
EOF
nounspec
nocontinue
# tcc-ext-test accepts "nocombine" --------------------------------------------
tcc/ext/tcc-ext-test  config nocombine
EOF
nocombine
nocontinue
# tcc-ext-test accepts "nocombine" and "nounspec" -----------------------------
tcc/ext/tcc-ext-test  config nocombine nounspec
EOF
nocombine
nounspec
nocontinue
# tcc-ext-test doesn't accept "foobar" ----------------------------------------
tcc/ext/tcc-ext-test config foobar 2>&1 | sed 1q
EOF
usage: tcc/ext/tcc-ext-test config [nounspec] [nocombine]
# barrier is understood by tcc-ext-match (class/drop) -------------------------
LD_LIBRARY_PATH=. PATH=$PATH:tcc/ext tcsim -Xc,-xif:test -Xx,nocombine | \
  awk '{ print $2 }'
dev eth0 100000 {
    dsmark {
       class if raw[0];
       drop if 1;
    }
}

send 0 0 x 19
send 1 0 x 19
end
EOF
E
*
E
D
# barrier is understood by tcc-ext-match (drop/class) -------------------------
LD_LIBRARY_PATH=. PATH=$PATH:tcc/ext tcsim -Xc,-xif:test -Xx,nocombine | \
  awk '{ print $2 }'
dev eth0 100000 {
    dsmark {
       drop if raw[0] == 1;
       class if 1;
    }
}

send 0 0 x 19
send 1 0 x 19
end
EOF
E
D
E
*
# barrier is understood by tcc-ext-match (class/unspec) -----------------------
LD_LIBRARY_PATH=. PATH=$PATH:tcc/ext tcsim -Xc,-xif:test -Xx,nocombine -v | \
  sed '/ at /s/.*returns //p;d'
dev eth0 100000 {
    dsmark {
       class (2) if raw[0] == 1;
    }
}

send 0 0 x 19
send 1 0 x 19
end
EOF
UNSPEC (-1)
OK (0) (1:2, 0x0)
